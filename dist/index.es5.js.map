{"version":3,"file":"index.es5.js","sources":["../src/index.ts"],"sourcesContent":["export type RequestHandler = (\n  query: string,\n  variables: Variables,\n  success: SuccessCallback,\n  errors: ErrorsCallback,\n) => void\n\nexport type SuccessCallback = (resp: { data?: any; errors?: any }) => void\nexport type ErrorsCallback = (message?: string) => void\nexport type OperationName = \"query\" | \"mutation\"\n\nexport interface VariableDecls {\n  [name: string]: {\n    type: string\n    value: any\n  }\n}\n\nexport interface Variables {\n  [name: string]: any\n}\n\nexport interface RequestParams {\n  [alias: string]: {\n    query: string\n    decls: VariableDecls\n    resolve: (value?: any | PromiseLike<any> | undefined) => void\n    reject: (reason?: any) => void\n  }\n}\n\nconst SELECTION_DELIMITER = /\\s|\\(|{/\n\n// Generate unique variable name\nconst uniqId = (() => {\n  let counter = 0\n  return (name?: string): string => `${name || \"id\"}${counter++}`\n})()\n\nconst buildQueryAndVariables = (\n  name: OperationName,\n  params: RequestParams,\n): { query: string; variables: Variables } => {\n  const queries: string[] = []\n  const variableDefinitions: string[] = []\n  const variables: Variables = {}\n\n  Object.keys(params).forEach(aliasName => {\n    const param = params[aliasName]\n    let query = param.query\n    Object.keys(param.decls)\n      .sort((a, b) => b.length - a.length) // Sort by length in descending order\n      .forEach(varName => {\n        const uniqName = uniqId(varName)\n        query = query.replace(`$${varName}`, `$${uniqName}`)\n        variableDefinitions.push(`$${uniqName}: ${param.decls[varName].type}`)\n        variables[uniqName] = param.decls[varName].value\n      })\n    queries.push(`${aliasName}:${query}`)\n  })\n\n  const defs = variableDefinitions.length\n    ? `(${variableDefinitions.join(\",\")})`\n    : \"\"\n  const query = `${name}${defs}{\\n${queries.join(\"\\n\")}\\n}`\n  return { query, variables }\n}\n\nconst createSuccessCallback = (params: RequestParams): SuccessCallback => ({\n  data,\n  errors,\n}) => {\n  if (data) {\n    Object.keys(data).forEach(aliasName => {\n      const param = params[aliasName]\n      const originalName = param.query.split(SELECTION_DELIMITER, 1)[0]\n      param.resolve({ [originalName]: data[aliasName] })\n    })\n  }\n  if (errors) {\n    // TODO: Implement\n  }\n}\n\nconst createErrorsCallback = (params: RequestParams): ErrorsCallback => (\n  message?: string,\n) => {\n  Object.keys(params).forEach(aliasName => {\n    params[aliasName].reject(message ? [message] : [])\n  })\n}\n\nexport const sendRequest = (\n  name: OperationName,\n  params: RequestParams,\n  handler: RequestHandler,\n): void => {\n  const { query, variables } = buildQueryAndVariables(name, params)\n  handler(\n    query,\n    variables,\n    createSuccessCallback(params),\n    createErrorsCallback(params),\n  )\n}\n\nexport class GraphQLClient {\n  private wait: number\n  private request: RequestHandler\n  private buffers: { [operation in OperationName]: RequestParams } = {\n    query: {},\n    mutation: {},\n  }\n  private timerIds: { [operation in OperationName]: number | null } = {\n    query: null,\n    mutation: null,\n  }\n\n  constructor(options: { wait?: number; request: RequestHandler }) {\n    this.wait = options.wait == null ? 50 : options.wait\n    this.request = options.request\n  }\n\n  public query<T>(query: string, decls: VariableDecls): Promise<T> {\n    return this.buffer(\"query\", query, decls)\n  }\n\n  public mutation<T>(query: string, decls: VariableDecls): Promise<T> {\n    return this.buffer(\"mutation\", query, decls)\n  }\n\n  private buffer<T>(\n    name: OperationName,\n    query: string,\n    decls: VariableDecls,\n  ): Promise<T> {\n    return new Promise((resolve, reject) => {\n      this.buffers[name][uniqId(\"alias\")] = {\n        query,\n        decls,\n        resolve,\n        reject,\n      }\n      if (!this.timerIds[name]) {\n        this.timerIds[name] = setTimeout(() => {\n          this.flush(name)\n        }, this.wait)\n      }\n    })\n  }\n\n  private flush(name: OperationName): void {\n    sendRequest(name, this.buffers[name], this.request)\n    this.buffers[name] = {}\n    this.timerIds[name] = null\n  }\n}\n"],"names":[],"mappings":"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"}